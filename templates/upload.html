<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°°ë‹¬ë¹„ ê´€ë¦¬ì</title>
  <style>
    .container {
      width: 100%;
      max-width: 1200px;
      background: #fff;
      padding: 20px 30px 40px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      box-sizing: border-box;
      text-align: center;
    }
   nav {
      background-color: #3498db;
      padding: 12px 20px;
      display: flex;
      gap: 20px;
      font-family: 'Segoe UI', sans-serif;
      margin: 0 0 40px 0;
      width: 100%;
      box-sizing: border-box;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      flex-grow: 1;
      text-align: center;
    }
    nav a.active {
      background-color: #2980b9;
    }
    nav a:hover {
      background-color: #2980b9;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      padding: 30px;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    form {
      align-items: center;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
      width: 100%;
      max-width: 600px;
      flex-wrap: wrap;
      padding: 10px;
    }
    label {
      white-space: nowrap;
      font-weight: 600;
    }
    input[type="file"] {
      flex-grow: 1;
      cursor: pointer;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
      min-width: 100px;
    }
    button:hover {
      background-color: #2980b9;
    }
    h3 {
      margin-top: 20px;
      margin-bottom: 20px;
      color: #34495e;
      text-align: center;
    }
    h4 {
      margin-top: 100px;
      margin-bottom: 30px;
      font-size: 18px;
      color: #34495e;
      text-align: left;
    }
    .summary {
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
      text-align: left;
    }
    .result-box {
      margin-bottom: 40px;
      border: 1px solid #ddd;
      padding: 15px 20px;
      border-radius: 10px;
      background-color: #fafafa;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      text-align: left;
      min-height: 150px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 14px;
      text-align: center;
      white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }
    th {
      background-color: #ecf0f1;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
input[type="checkbox"] {
  transform: scale(1.8); /* í¬ê¸° 1.8ë°° */
  margin-right: 8px;
  vertical-align: middle; /* í…ìŠ¤íŠ¸ì™€ ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
  cursor: pointer;
}


textarea {
  width: 600px;
  resize: none;
  overflow: hidden;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px;
  font-family: 'Segoe UI', sans-serif;
  box-sizing: border-box;
}
  </style>
</head>
<body>

  <div class="container">
    <nav>
      <a href="/admin-member">íšŒì›ê´€ë¦¬</a>
      <a href="/admin-manage" class="active">ì¼ì •ì‚°</a>
      <a href="/admin-week">ì£¼ ì •ì‚°</a>
      <a href="/admin-add">ì£¼ ì •ì‚° ê¸°íƒ€ ë“±ë¡</a>
      <a href="/admin-month">ì„¸ê¸ˆ</a>
    </nav>

    <!-- ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš© -->
    <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; min-height: 20vh;">
      <form id="uploadForm">
        <div style="margin-bottom: 20px;">
          <label>ì¼ ì •ì‚° íŒŒì¼ : </label>
          <input type="file" id="file1" name="file1" accept=".xlsx" required />
        </div>
        <div style="margin-bottom: 20px;">
          <label>ë³´í—˜ë£Œ íŒŒì¼ : </label>
          <input type="file" id="file2" name="file2" accept=".xlsx"  required />
        </div>
        <div style="text-align: center; margin-top: 30px;">
          <button type="submit">ì—…ë¡œë“œ</button>
        </div>
      </form>
    </div>
<h3 id="checkedTotal">âœ… ì„ íƒëœ ë¼ì´ë” í•©ê³„: 0ì›</h3>
    <h3>ì§‘ê³„ ê²°ê³¼</h3>
    <div id="resultCombined" class="result-box">
      <!-- ì¼ì •ì‚° + ë³´í—˜ë£Œ ê²°ê³¼ ì˜ì—­ -->
    </div>
  </div>

  <script>

  const password = "3458";
  const PASSWORD_KEY = "admin_password";

  // localStorageì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  const savedPassword = localStorage.getItem(PASSWORD_KEY);

  if (savedPassword !== password) {
    const input = prompt("í˜„ê´€ë¬¸(ì•ˆìª½) ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

    if (input !== password) {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹«ìŠµë‹ˆë‹¤.");
      window.close();  // ë¸Œë¼ìš°ì €ê°€ í—ˆìš©í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë˜ë¡œ ëŒ€ì²´
      document.body.innerHTML = "<h2>ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</h2>";
    } else {
      // ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ë©´ localStorageì— ì €ì¥
      localStorage.setItem(PASSWORD_KEY, password);
    }
  }

  function formatDate(yyyyMMdd) {
    const year = yyyyMMdd.substring(0, 4);
    const month = yyyyMMdd.substring(4, 6);
    const day = yyyyMMdd.substring(6, 8);
    return `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
  }

  function formatCurrency(value) {
    return Number(value).toLocaleString() + 'ì›';
  }

  document.getElementById("uploadForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const resultCombined = document.getElementById("resultCombined");

    // ê²°ê³¼ ì´ˆê¸°í™”
    resultCombined.innerHTML = "";

    if (!file1 || !file2) {
      alert("íŒŒì¼ ë“±ë¡í•´ì£¼ì„¸ìš”.");
      return;
    }

    const formData = new FormData();
    if(file1){
        formData.append("file1", file1);
    }
    if(file2){
        formData.append("file2", file2);
    }

    alert('ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ìƒì„± ì¤‘ ì…ë‹ˆë‹¤.');

    let data;
    try {
      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });
      data = await res.json();
    } catch (err) {
      resultCombined.textContent = "íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      return;
    }

    if (data.status !== "success") {
      resultCombined.textContent = "ì„œë²„ ì˜¤ë¥˜: " + (data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
      return;
    }

    const result = data.data;
    if (Object.keys(result).length === 0) {
      alert('ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
     const notes = data.note;
     for (const rider in result) {
        const riderData = result[rider];
        const moto_fee = Number(riderData["moto_fee"]) || 0;

        // ì´ˆê¸° days (ê¸°ì¡´ì— ì„œë²„ê°€ ì œê³µí•˜ë˜ ê°’)
        let days = 1;

        // ë¼ì´ë” ì˜ì—­ ìƒì„±
        const riderSection = document.createElement("div");

        const riderTitle = document.createElement("h4");
        riderTitle.textContent = `${rider} (ìµœì¢… í•©ê³„: ê³„ì‚° ì¤‘...) `;

        // âœ… ì¶”ê°€: ë¼ì´ë”ë³„ ì²´í¬ë°•ìŠ¤
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginRight = "8px";
        riderTitle.prepend(checkbox);

        // âœ… ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì „ì²´ í•©ê³„ ê°±ì‹ 
        checkbox.addEventListener("change", () => {
          updateCheckedTotal();
        });

        const registerBtn = document.createElement("button");
        registerBtn.textContent = "ê¸°íƒ€ ë“±ë¡";
        registerBtn.style.marginLeft = "10px";




        registerBtn.addEventListener("click", async (e) => {

        const file1 = document.getElementById("file1").files[0];
        const file2 = document.getElementById("file2").files[0];

        const file1Name = file1?.name || "";
        const file2Name = file2?.name || "";
        console.log(file1Name);
        console.log(file2Name);

        if(!file1Name || !file2Name){
          alert('íŒŒì¼ ì˜¤ë¥˜');
          return;
        }
          const regex = /_(\d{8})_(\d{8})\.xlsx$/;

          const match1 = file1Name.match(regex);
          const match2 = file2Name.match(regex);

        console.log(match1);
        console.log(match2);
          if (!match1 || !match2) {
            alert('íŒŒì¼ ì´ë¦„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }

          let start_date = null;
          let end_date = null;

          if (match1[0] === match2[0] && match1[1] === match2[1]) {
            start_date = match1[1];
            end_date = match1[2];
          } else {
            alert('íŒŒì¼ ì˜¤ë¥˜');
            return;
          }


        const h4 = e.target.closest("div").querySelector("h4");

          if (!h4) {
            alert("ë¼ì´ë” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const text = h4.textContent;

          // ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ê¸ˆì•¡ë§Œ ì¶”ì¶œ (ìˆ«ì + 'ì›' í¬í•¨)
          const match = text.match(/([0-9,]+)ì›/);
          const sumText = match ? match[1] : "0";
          const onlyNumber = parseInt(sumText.replace(/,/g, ""), 10);

          // ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ì´ë¦„ ì¶”ì¶œ (ê´„í˜¸ ì´ì „ê¹Œì§€)
          const nameMatch = text.match(/^(.+?)\s*\(/);
          const rider = nameMatch ? nameMatch[1].trim() : "Unknown";

          console.log("ë¼ì´ë”:", rider);
          console.log("í•©ê³„ ê¸ˆì•¡:", onlyNumber);

          // ì„œë²„ ì „ì†¡
          const payload = {
            rider,
            finalSum: onlyNumber,
            start_date: start_date,
            end_date: end_date
          };

          try {
            const res = await fetch("/api/extra-register", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(payload)
            });
            const resJson = await res.json();
              alert(`'ê¸°íƒ€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } catch (err) {
            alert("ì„œë²„ ì˜¤ë¥˜: ê¸°íƒ€ ë“±ë¡ ì‹¤íŒ¨");
          }
        });

        riderTitle.appendChild(registerBtn);

         // ğŸ”½ ì¶”ê°€ëœ ë¶€ë¶„ ì‹œì‘: toggle button + riderBody
        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = "+";
        toggleBtn.style.marginLeft = "10px";
        toggleBtn.style.fontWeight = "bold";
        toggleBtn.style.cursor = "pointer";

        const riderBody = document.createElement("div");
        riderBody.classList.add("rider-body");
        riderBody.style.display = "none";

        toggleBtn.addEventListener("click", () => {
          const isVisible = riderBody.style.display === "block";
          riderBody.style.display = isVisible ? "none" : "block";
          toggleBtn.textContent = isVisible ? "+" : "âˆ’";
        });

        riderTitle.appendChild(toggleBtn);
        // ğŸ”¼ ì¶”ê°€ëœ ë¶€ë¶„ ë


            // **readonlyë¡œ note ë³´ì—¬ì¤„ ê³µê°„ ì¶”ê°€**

            const noteDisplay = document.createElement("textarea");
             noteDisplay.readOnly = true;
              noteDisplay.style.width = "50%";
              noteDisplay.style.marginTop = "8px";
              noteDisplay.style.resize = "none";
              noteDisplay.style.border = "1px solid #ccc";
              noteDisplay.style.borderRadius = "6px";
              noteDisplay.style.padding = "6px";
              noteDisplay.style.fontFamily = "'Segoe UI', sans-serif";


                // rider ë³€ìˆ˜ì— í˜„ì¬ ë¼ì´ë” ì´ë¦„ì´ ë“¤ì–´ìˆë‹¤ê³  ê°€ì •
                const riderName = rider;  // ì˜ˆ: "í™ê¸¸ë™"
              console.log(rider);
                // í•´ë‹¹ ë¼ì´ë” ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ” ê°ì²´ ì°¾ê¸°
                const riderNoteObj = notes.find(item => item.name === riderName);

                // note ê°’ í• ë‹¹ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
                const riderNote = riderNoteObj ? riderNoteObj.note : "";
                console.log(riderNote);
              // ë‚´ìš© ë„£ê³  ë†’ì´ ìë™ ë§ì¶”ê¸°
              noteDisplay.value = riderNote;



              riderTitle.appendChild(noteDisplay);  // DOMì— ë¨¼ì € ì¶”ê°€
        riderSection.appendChild(riderTitle);



        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>ìš´í–‰ì¼</th>
            <th>ë°°ë‹¬ì²˜ë¦¬ë¹„=A</th>
            <th>4.9%=B</th>
            <th>ì‹œë³´=C</th>
             <th>ì˜¤í†  (<span>${formatCurrency(moto_fee)} Ã— </span><input type="number" value="${days}" min="1" class="daysInput" style="width:40px; display:inline-block;" />&nbsp;ì¼)=D</th>
            <th>ì¼ í•©ê³„ ê¸ˆì•¡(A-B-C-D)</th>
          </tr>
        `;
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        table.appendChild(tbody);
        //riderSection.appendChild(table);
          riderBody.appendChild(table);
          riderSection.appendChild(riderBody);


        resultCombined.appendChild(riderSection);

        function recalculateTable(currentDays) {
          let finalSum = 0;
          tbody.innerHTML = "";

          for (const record of riderData["ê¸°ë¡"]) {
            const tr = document.createElement("tr");

            const ìš´í–‰ì¼ = record["ìš´í–‰ì¼"];
            const formattedDate = ìš´í–‰ì¼.length === 8 ? formatDate(ìš´í–‰ì¼) : ìš´í–‰ì¼;

            const ë°°ë‹¬ì²˜ë¦¬ë¹„ = Number(record["ë°°ë‹¬ì²˜ë¦¬ë¹„"]) || 0;
            const ë³´í—˜ë£Œ = Number(record["ë³´í—˜ë£Œ ë°œìƒê¸ˆì•¡(ì›)"]) || 0;

            const afterTax = Math.floor(ë°°ë‹¬ì²˜ë¦¬ë¹„ *  0.049);
            const motoFeeTotal = moto_fee * currentDays;
            const afterMoto = ë°°ë‹¬ì²˜ë¦¬ë¹„ - afterTax - ë³´í—˜ë£Œ - motoFeeTotal;

            finalSum += afterMoto;

            tr.innerHTML = `
              <td>${formattedDate}</td>
              <td>${formatCurrency(ë°°ë‹¬ì²˜ë¦¬ë¹„)}</td>
              <td>${formatCurrency(afterTax)}</td>
              <td>${formatCurrency(ë³´í—˜ë£Œ)}</td>
              <td>${formatCurrency(motoFeeTotal)}</td>
              <td>${formatCurrency(afterMoto)}</td>
            `;
            tbody.appendChild(tr);
          }

        //  riderTitle.firstChild.textContent = `${rider} (ì „ì²´ í•©ê³„: (A-B-C-D) = ${formatCurrency(finalSum)})  `;
checkbox.nextSibling.nodeValue = `${rider} (ì „ì²´ í•©ê³„: (A-B-C-D) = ${formatCurrency(finalSum)})  `;





        }




        // ì´ˆê¸° ê³„ì‚°
        recalculateTable(days);

       // í…Œì´ë¸” ì‚½ì… í›„ input ê°€ì ¸ì˜¤ê¸°
        const daysInputTh = thead.querySelector('.daysInput');

        // ì´ˆê¸° ë Œë”ë§
        recalculateTable(Number(daysInputTh.value));

        // ë³€ê²½ ì‹œ ë¦¬ë Œë”ë§
        daysInputTh.addEventListener("input", () => {
          recalculateTable(Number(daysInputTh.value));
        });

    
            document.querySelectorAll('textarea').forEach(autoResize);
      }
   });


function updateCheckedTotal() {
  let total = 0;
  const checkboxes = document.querySelectorAll('#resultCombined input[type="checkbox"]');

  checkboxes.forEach(cb => {
    if (cb.checked) {
      const h4 = cb.parentElement;
      const text = h4.textContent;

      // "ì „ì²´ í•©ê³„" ë˜ëŠ” "ìµœì¢… í•©ê³„" ëª¨ë‘ ëŒ€ì‘
      const match = text.match(/í•©ê³„.*?([0-9,]+)ì›/);
      if (match) {
        total += parseInt(match[1].replace(/,/g, ''), 10);
      }
    }
  });

  const totalDisplay = document.getElementById("checkedTotal");
  totalDisplay.textContent = `âœ… ì„ íƒëœ ë¼ì´ë” í•©ê³„: ${total.toLocaleString()}ì›`;
}
function autoResize(textarea) {
  textarea.style.height = 'auto';  // ë†’ì´ ì´ˆê¸°í™”
  textarea.style.height = (textarea.scrollHeight) + 'px';  // ìŠ¤í¬ë¡¤ ë†’ì´ë§Œí¼ í™•ì¥
}

 </script>
</body>
</html>